name: Feature Branch CI (ë‹¨ìˆœí™”)

on:
  push:
    branches:
      - 'feature/**'

jobs:
  ci-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ê¸°ë³¸ ì²´í¬
      run: |
        echo "ğŸ” Feature ë¸Œëœì¹˜ ê¸°ë³¸ ì²´í¬ ì¤‘..."
        echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        ls -la
    
    - name: Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ”¨ Docker ë¹Œë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸..."
        
        # Backend ë¹Œë“œ ì²´í¬
        if [ -f "backend/Dockerfile" ]; then
          echo "âœ… Backend Dockerfile ì¡´ì¬"
          cd backend && docker build --dry-run . && cd ..
        fi
        
        # Frontend ë¹Œë“œ ì²´í¬  
        if [ -f "frontend/Dockerfile" ]; then
          echo "âœ… Frontend Dockerfile ì¡´ì¬"
          cd frontend && docker build --dry-run . && cd ..
        fi
    
    - name: ìë™ PR ìƒì„± (feature â†’ dev)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH_NAME: ${{ github.ref_name }}
        REPO: ${{ github.repository }}
      run: |
        echo "ğŸ”„ GitHub CLIë¡œ PR ìƒì„± ì¤‘..."
        
        # PR ì œëª©ê³¼ ë³¸ë¬¸ ì„¤ì •
        PR_TITLE="ğŸš€ [ìë™ìƒì„±] ${BRANCH_NAME} â†’ dev"
        PR_BODY="## ğŸ“‹ ë³€ê²½ì‚¬í•­
        - Feature ë¸Œëœì¹˜: \`${BRANCH_NAME}\`
        - ì»¤ë°‹ í•´ì‹œ: \`${{ github.sha }}\`
        - ì‘ì„±ì: ${{ github.actor }}
        - í‘¸ì‹œ ì‹œê°„: $(date -u)
        
        ## ğŸ” ì²´í¬ë¦¬ìŠ¤íŠ¸
        - [x] Docker ë¹Œë“œ ê°€ëŠ¥ í™•ì¸
        - [ ] ì½”ë“œ ë¦¬ë·° í•„ìš”
        - [ ] ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ í•„ìš”
        - [ ] ì¶©ëŒ í•´ê²° í™•ì¸
        
        ## ğŸ¤– ìë™ ìƒì„±ëœ PR
        ì´ PRì€ \`${BRANCH_NAME}\` ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
        
        **âš ï¸ ë³‘í•© ì „ í™•ì¸ì‚¬í•­:**
        1. âœ… ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
        2. âœ… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ  
        3. âœ… ì¶©ëŒ í•´ê²° ì™„ë£Œ
        4. âœ… CI ì²´í¬ í†µê³¼"
        
        # ê¸°ì¡´ PR í™•ì¸
        EXISTING_PR=$(gh pr list --head "${BRANCH_NAME}" --base "dev" --state open --json number --jq '.[0].number' || echo "")
        
        if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
          echo "âš ï¸ ê¸°ì¡´ PR #${EXISTING_PR}ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
          echo "ğŸ”— PR URL: https://github.com/${REPO}/pull/${EXISTING_PR}"
        else
          # ìƒˆ PR ìƒì„±
          echo "ğŸ“ ìƒˆë¡œìš´ PR ìƒì„± ì¤‘..."
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base "dev" \
            --head "${BRANCH_NAME}" \
            --repo "$REPO")
          
          echo "âœ… PR ìƒì„± ì™„ë£Œ!"
          echo "ğŸ”— PR URL: $PR_URL"
        fi
        
    - name: PR ìƒì„± ê²°ê³¼
      run: |
        echo "âœ… Feature ë¸Œëœì¹˜ CI ì™„ë£Œ"
        echo "ğŸ“ ìë™ PRì´ dev ë¸Œëœì¹˜ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"
        echo "ğŸ”— GitHubì—ì„œ PRì„ í™•ì¸í•˜ì„¸ìš”"