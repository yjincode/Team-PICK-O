name: Dev Branch CI (ë¹Œë“œ ë° íƒ€ì… ì²´í¬)

on:
  pull_request:
    branches:
      - dev
  # dev ë¸Œëœì¹˜ ì§ì ‘ í‘¸ì‹œëŠ” ì œì™¸ (PR í†µí•´ì„œë§Œ ì§„í–‰)

jobs:
  typescript-check:
    runs-on: ubuntu-latest
    name: TypeScript ì—ëŸ¬ ì²´í¬
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Frontend ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci
    
    - name: TypeScript íƒ€ì… ì²´í¬
      run: |
        cd frontend
        echo "ğŸ” TypeScript íƒ€ì… ì—ëŸ¬ ì²´í¬ ì¤‘..."
        npx tsc --noEmit
        echo "âœ… TypeScript íƒ€ì… ì²´í¬ ì™„ë£Œ"
    
    - name: ESLint ì²´í¬
      run: |
        cd frontend
        echo "ğŸ” ESLint ì²´í¬ ì¤‘..."
        npm run lint || echo "âš ï¸ ESLint ê²½ê³ ê°€ ìˆìŠµë‹ˆë‹¤"
        echo "âœ… ESLint ì²´í¬ ì™„ë£Œ"

  build-check:
    runs-on: ubuntu-latest
    needs: typescript-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ê¸°ë³¸ ì •ë³´
      run: |
        echo "ğŸ” Dev ë¸Œëœì¹˜ ë¹Œë“œ ì²´í¬ ì¤‘..."
        echo "ì´ë²¤íŠ¸: ${{ github.event_name }}"
        echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
    
    - name: Frontend Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ”¨ Frontend Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
        cd frontend
        
        # frontend Dockerfileë¡œ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        docker build -t frontend-test .
        echo "âœ… Frontend ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ"
        
        # ì´ë¯¸ì§€ ì •ë¦¬
        docker rmi frontend-test
    
    - name: Backend Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ”¨ Backend Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
        cd backend
        
        # backend Dockerfileë¡œ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        docker build -t backend-test .
        echo "âœ… Backend ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ"
        
        # ì´ë¯¸ì§€ ì •ë¦¬
        docker rmi backend-test
    
    - name: Docker ì»´í¬ì¦ˆ ì„¤ì • ê²€ì¦
      run: |
        echo "ğŸ”¨ Docker Compose ì„¤ì • ê²€ì¦..."
        cd deployment
        
        # ì„¤ì • íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
        docker compose config
        echo "âœ… Docker Compose ì„¤ì • ìœ íš¨"
        
        # ê°œë°œìš© ì„¤ì • ê²€ì¦
        if [ -f "docker-compose.dev.yml" ]; then
          docker compose -f docker-compose.dev.yml config
          echo "âœ… ê°œë°œìš© Docker Compose ì„¤ì • ìœ íš¨"
        fi
    
    - name: í”„ë¡œë•ì…˜ ì¤€ë¹„ í™•ì¸
      run: |
        echo "ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸..."
        
        # í•„ìˆ˜ íŒŒì¼ ì²´í¬
        files_to_check=(
          "backend/Dockerfile"
          "backend/requirements.txt"
          "frontend/Dockerfile" 
          "frontend/package.json"
          "deployment/docker-compose.yml"
        )
        
        for file in "${files_to_check[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file ì¡´ì¬"
          else
            echo "âŒ $file ëˆ„ë½"
            exit 1
          fi
        done
        
        echo "âœ… ëª¨ë“  í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸"
    
    - name: ë¹Œë“œ ì™„ë£Œ
      run: |
        echo "âœ… Dev ë¸Œëœì¹˜ CI ì™„ë£Œ"
        echo "ğŸ“ TypeScript íƒ€ì… ì²´í¬: í†µê³¼"
        echo "ğŸ³ Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸: í†µê³¼"
        echo "ğŸš€ main ë¸Œëœì¹˜ë¡œ ë³‘í•© ì‹œ ìë™ ë°°í¬ë©ë‹ˆë‹¤"